---
title: "Semester Project"
author: "Stephen Trippy"
date: "4/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Libraries! I need a few:
```{r}
library("dplyr")
library("jsonlite")
library("httr")
library("readxl")
library("tidyr")
library("ggplot2")
```

# Creating vector of Harris County Zip codes

This will allow us to query restaurants by zip code. Zip code data was copied from
https://www.zillow.com/browse/homes/tx/harris-county/
and pasted into a .csv file

Before doing this, we must make sure that the csv file is in our working directory
```{r}
harris_zips <- read.csv('harris_zipcodes.csv')
```

Next, we read in census data, which is taken from 2006-2010. While unfortunately the api data is current, we can make a decent assumption that wealth levels per zip code have not changed too much

Census data was sourced from:
https://www.psc.isr.umich.edu/dis/census/Features/tract2zip/

```{r}
#read the demographic data in. cells with no data are marked with a '.'

zip_demographic_data <- read_excel('zipcode_census_data.xlsx', sheet = 'nation', na = ".") %>% 
  rename(zip_code = Zip)
harris_data_by_zip <- inner_join(harris_zips, zip_demographic_data, by = 'zip_code')

#Some of the zip codes in harris_zips had no demographic data, so i decided to inner_join. 
#I could left join though, if I really felt like keeping all of the restaurant data from these zip codes
```

Let's play around with the data we've just gotten
```{r}
harris_data_by_zip %>% 
  arrange(desc(Median)) %>% 
  head(15)

#small sample of the 15 wealthiest zip codes by median income in Harris county. Neat!
```

```{r}
#Loading the API key from a separate file
source("yelp_api_key.R") #allows yelp_key to be available

#info in order to make GET request, using API key as a header
base_uri <- "https://api.yelp.com/v3"
endpoint <- "/businesses/search"
search_uri <- paste0(base_uri, endpoint)

```


Now, we prepare to query. My original plan was to cycle through every zip code in Harris county, pulling as many restaurants as there were from each zip code. 

However, there seems to be a problem with the yelp api. When I tried to query by one particular zip code, restaurants from other zip codes would get pulled back.

My new plan is to just pull as many restaurants as I can within a certain radius of Houston. This won't really answer my initial quesition, but it may still give me some worthwhile data

```{r}
zip_restaurant_list = list()
restaurant_list = list()

for(j in 1:length(harris_data_by_zip$zip_code)){
  zip_code_n <- harris_data_by_zip$zip_code[j]
  
offset_counter <- 1
results_returned <- 50

#making the somewhat arbitrary decision to return a maximum of 250 results per zip code. I think that this is a good enough amount to get a decent sample of each zip in Harris County, assuming yelp shows us the correct zips

#for(i in 1:2){
  
    query_params <- list(
      term = "Restaurants",
      location = zip_code_n,
      sort_by = "distance",
      limit = results_returned
      #offset = offset_counter
    )
    response <- GET(
      search_uri, 
      query = query_params, 
      add_headers(Authorization = paste("bearer", yelp_key))
    )
    response_text <- content(response, type = "text")
    response_data <- fromJSON(response_text)
    restaurants <- flatten(response_data$businesses)
  
    #each set of restaurants pulled is added to the restaurant list
    restaurant_list[[j]] <- restaurants
  
    #offset_counter <- offset_counter + 50
  
#}
#zip_n_list <- bind_rows(restaurant_list)
#zip_restaurant_list[[j]] <- zip_n_list
}
```


```{r}
#if working, this code would compile all listed dataframes into a master dataframe, containing many restaurants

#take all of the data we've just extracted. Now bind it into one masterlist
masterlist <-bind_rows(restaurant_list) 

#remove the duplicate restaurants (each restaurant should have a unique id)
masterlist <- masterlist[!duplicated(masterlist$id), ]

masterlist <- masterlist %>% rename(zip_code = location.zip_code) 
masterlist$zip_code <- as.double(masterlist$zip_code)

masterlist %>% 
  arrange() %>% 
  select(zip_code, location.city)

joined_masterlist <- masterlist %>% 
  group_by(zip_code) %>% 
  count() %>% 
  right_join(harris_data_by_zip, by = "zip_code")

joined_masterlist %>% 
  arrange(desc(Median)) %>% 
  head(10)

#joined_masterlist %>% 
  #ggplot(aes(n)) + geom_density()
```

```{r}
#a peek at the masterlist
masterlist %>%
  select(name, location.zip_code)

#are there any cities (Not Houston) That get returned?
masterlist$location.city %>% 
  unique()

#looks like a few do for some reason
masterlist %>% 
  filter(location.city == "Carle Place" | location.city == "New York" | location.city == "HOUSTON" | location.city == "Bellaire") %>% 
  select(name, location.city, location.address1)

```

One thing I'm worried about is that I might not want to limit myself to restaurants within 'Houston.' As a result, maybe it'll be better to search restaurants within a certain radius of Houston, using the coordinates of Houston as a center point and then sort_by distance

```{r}

```